<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Assistant</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 120px;
            position: relative;
        }

        header {
            background: #ffffff;
            padding: 12px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 95%;
            margin: 0 auto;
        }

        .header-left {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 40px;
            object-fit: contain;
            margin-right: 20px;
        }

        .header-center {
            flex: 2;
            text-align: center;
        }

        .header-title {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .header-right {
            flex: 1;
            display: flex;
            justify-content: flex-end;
        }

        .sign-in-btn {
            background: transparent;
            border: 2px solid #007bff;
            color: #007bff;
            padding: 8px 24px;
            border-radius: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sign-in-btn:hover {
            background: #007bff;
            color: white;
        }

        .sign-in-btn:active {
            transform: scale(0.98);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: white;
            padding: 20px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 80px;
            background-color: white;
        }

        .input-container {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            border-top: 0px solid white;
            box-shadow: 0 0px 0px rgba(0, 0, 0, 0);
            z-index: 100;
            transition: all 0.5s ease;
        }

        /* Initial centered state */
        .input-container.initial {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            bottom: auto;
            box-shadow: none;
        }

        .input-wrapper {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
        }

        .message-input {
            width: 100%;
            padding: 12px 60px 12px 16px;
            /* extra right padding for the send button */
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            outline: none;
            font-family: inherit;
            font-size: 16px;
            resize: none;
            line-height: 1.5;
            min-height: 56px;
            max-height: 150px;
            overflow-y: auto;
            transition: all 0.2s;
            background-color: rgb(243, 244, 246);
        }

        .message-input:focus {
            border-color: #b6b7b8;
            box-shadow: 0 0 0 2px rgb(243, 244, 246);
        }

        .send-button {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #005bb5;
        }

        footer {
            background: white;
            padding: 16px;
            text-align: center;
            font-size: 0.9em;
            color: #666;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            border-top: 0px solid #e0e0e0;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 4px 0;
        }

        .user-message {
            background: #eff6ff;
            color: black;
            align-self: flex-end;
        }

        .bot-message {
            background: #f1f3f4;
            color: #202124;
            align-self: flex-start;
            padding-bottom: 12px;
            line-height: 1.6;
            /* Increased from 1.5 */
            word-spacing: 0.5px;
            letter-spacing: 0.2px;
        }

        /* For paragraph-like spacing in longer answers */
        .bot-message div {
            font-size: 16px;
            margin-bottom: 8px;
        }

        /* If you're rendering markdown content */
        .bot-message strong {
            letter-spacing: 0.3px;
        }

        .bot-message em {
            letter-spacing: 0.1px;
        }

        button {
            /* Other buttons (like sign in, new chat) retain these styles */
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
            height: 40px;
        }

        .related-questions {
            margin-top: 8px;
            width: 100%;
        }

        .related-question-btn {
            background: #e8f0fe;
            color: #1967d2;
            border: none;
            border-radius: 16px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .copy-container {
            display: flex;
            justify-content: flex-start;
            width: 100%;
            margin-top: 8px;
        }

        .copy-button,
        .feedback-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            padding: 6px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .copy-button:hover,
        .feedback-button:hover {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .copy-button svg,
        .feedback-button svg {
            width: 18px;
            height: 18px;
            display: block;
            margin: auto;
        }

        .copy-button:active {
            transform: scale(0.95);
        }

        .copy-button:hover {
            background: rgba(25, 103, 210, 0.1);
            color: #007bff;
            transform: scale(1.1);
        }



        .copy-success {
            color: #0f9d58;
            font-size: 0.8em;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .show-copy-feedback .copy-success {
            opacity: 1;
        }

        .references-section {
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .reference-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .reference-header:hover {
            background-color: #f1f3f4;
        }

        .reference-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .reference-content.expanded {
            padding: 15px;
            max-height: 500px;
        }

        .chevron-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.3s;
        }

        .chevron-icon.expanded {
            transform: rotate(180deg);
        }

        .chunk-info {
            font-size: 0.9em;
            color: #5f6368;
            margin-bottom: 10px;
        }

        .doc-link {
            color: #1967d2;
            text-decoration: none;
            font-size: 0.9em;
            display: inline-block;
            margin-top: 8px;
        }

        .doc-link:hover {
            text-decoration: underline;
        }

        /* Adjust new chat container to avoid overlap */
        .new-chat-container {
            position: fixed;
            /*bottom: 220px;*/
            bottom: 170px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .new-chat-visible {
            opacity: 1;
            visibility: visible;
        }

        .new-chat-btn {
            background: #ffffff;
            color: #007bff;
            border: 1px solid #e0e0e0;
            padding: 8px 24px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            font-weight: 500;
            font-family: inherit;
            font-size: 16px;
        }

        .new-chat-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
            box-shadow: 0 2px 12px rgba(0, 123, 255, 0.15);
        }

        .new-chat-btn:active {
            transform: scale(0.98);
        }

        /* Add this CSS for the loading effect */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 4px;
            background-color: #007bff;
            border-radius: 50%;
            animation: loading 0.6s infinite alternate;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loading {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.5);
            }
        }

        .scroll-to-bottom-btn {
            position: fixed;
            bottom: 140px;
            right: 30px;
            width: 40px;
            height: 40px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .scroll-to-bottom-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .scroll-to-bottom-btn.visible {
            opacity: 1;
            visibility: visible;
        }

        .coming-soon-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 0.9em;
            opacity: 0;
            visibility: hidden;
            transition: all 0.7s ease;
            z-index: 2000;
            pointer-events: none;
        }

        .coming-soon-alert.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -55%);
        }

        .sign-in-btn:active {
            transform: scale(0.98);
            /* Add transition to base state */
            transition: all 0.2s ease;
        }

        /* Add this to make the button interactive even when not active */
        .sign-in-btn {
            transition: all 0.7s ease;
        }

        .feedback-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .feedback-button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s ease;
        }

        .feedback-button:hover {
            color: #007bff;
            transform: scale(1.1);
        }

        .feedback-button:active {
            transform: scale(0.95);
        }


        .coming-soon-alert.feedback-alert {
            bottom: 120px;
            top: auto;
            transform: translateX(-50%);
            left: 50%;
            background: rgba(0, 123, 255, 0.9);
        }

        .coming-soon-alert.feedback-alert.show {
            transform: translate(-50%, -10px);
        }

        /* Add these styles to your CSS */
        .button-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .button-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -4px;
            border-width: 4px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        button:hover .button-tooltip {
            opacity: 1;
        }

        /* Add these new styles to existing CSS */
        .validation-message {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107;
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .validation-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .validation-text {
            flex: 1;
        }

        .validation-message strong {
            color: #856404;
            display: block;
            margin-bottom: 8px;
        }

        .welcome-message {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -60%);
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            opacity: 1;
            transition: all 0.3s ease;
            text-align: center;
            pointer-events: none;
            z-index: 2000;
            display: none;
            /* Start hidden */
        }

        .welcome-message.show {
            display: block;
            /* Show only when needed */
            opacity: 1;
        }

        .welcome-message.hidden {
            opacity: 0;
            transform: translate(-50%, -40%);
            display: none !important;
            /* Force hide */
        }
    </style>
</head>

<body>

    <header>
        <div class="header-content">
            <div class="header-left">
                <img src="" alt="Engen Logo" class="header-logo" />
            </div>
            <div class="header-center">
                <h2 class="header-title">Knowledge Management</h2>
            </div>
            <div class="header-right">
                <button class="sign-in-btn">Sign In</button>
            </div>
        </div>
    </header>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <div class="new-chat-container" id="newChatContainer">
        <div class="loading-dots" id="loadingDots" style="display: none;">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <button class="new-chat-btn" onclick="clearSessionAndChat()">ask new question</button>
    </div>

    <div class="welcome-message" id="welcomeMessage">Hey Guest</div>

    <div class="input-container initial">
        <div class="input-wrapper">
            <textarea id="userInput" rows="2" class="message-input" placeholder="Type your message..."></textarea>
            <button class="send-button" onclick="handleSendMessage()">Send</button>
        </div>
    </div>
    <div class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Jump to latest message">
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path fill="currentColor" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z" />
        </svg>
    </div>
    <footer>
        <p>© 2024 Chat Interface. All rights reserved.</p>
    </footer>

    <script>
        // Add these constants at the top with other declarations
        const SHORT_MESSAGES = ['hey', 'hello', 'hi', 'hola', 'hey there', 'hi there'];
        const VALIDATION_RESPONSE = {
            type: 'bot',
            validation: true,
            content: "🌟 **Hello!**\nI'd be happy to help! Could you please elaborate on your question so I can provide the most helpful response?"
        };
        function getDomain() {
            return atob("aHR0cHM6Ly90ZXN0LmNvbnZlcnNhdGlvbi5nb2VuZ2VuLmNvbQ==");
        }
        const DOMAIN = atob("aHR0cHM6Ly90ZXN0LmNvbnZlcnNhdGlvbi5nb2VuZ2VuLmNvbQ==");
        let messages = [];
        let currentSession = sessionStorage.getItem('chatSession') || null;
        let isFirstInteraction = true; // New state variable

        // Simple markdown-to-HTML conversion for basic formatting
        function markdownToHTML(markdown) {
            // Convert bold text: **text** to <strong>text</strong>
            markdown = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Convert italic text: *text* to <em>text</em>
            markdown = markdown.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Convert newlines to <br>
            markdown = markdown.replace(/\n/g, '<br>');
            return markdown;
        }

        async function handleSendMessage() {


            const userInput = document.getElementById('userInput');
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            // Clear placeholder after first interaction
            if (isFirstInteraction) {
                userInput.placeholder = '';
                isFirstInteraction = false;
            }

            // Check for short messages
            if (SHORT_MESSAGES.includes(userMessage)) {
                messages.push({ type: 'user', content: userInput.value.trim() });
                messages.push(VALIDATION_RESPONSE);
                renderChat();
                userInput.value = '';
                return;
            }


            messages.push({ type: 'user', content: userMessage });
            renderChat();
            userInput.value = '';
            // Show loading effect
            document.getElementById('loadingDots').style.display = 'flex';

            try {
                const requestBody = {
                    query: userMessage,
                    ...(currentSession && { session: currentSession })
                };
                console.log(requestBody);
                const response = await fetch(
                    `${DOMAIN}/code-translate/v1alpha/data-discovery/prompt`,
                    {
                        method: 'POST',
                        headers: {
                            accept: 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    }
                );

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();

                if (data.session?.name) {
                    console.log('Session:', data.session.name);
                    currentSession = data.session.name;
                    sessionStorage.setItem('chatSession', currentSession);
                }

                messages.push({
                    type: 'bot',
                    content: data.answer.answerText,
                    relatedQuestions: data.answer.relatedQuestions,
                    references: data.answer.references || []
                });

                if (messages.length === 1) {
                    document.getElementById('newChatContainer').classList.add('new-chat-visible');
                }

                renderChat();
            } catch (error) {
                console.error('API Error:', error);
                messages.push({
                    type: 'bot',
                    content: 'Sorry, there was an error processing your request.',
                    references: []
                });
                renderChat();
            } finally {
                // Hide loading effect
                document.getElementById('loadingDots').style.display = 'none';
            }
        }

        function clearSessionAndChat() {
            sessionStorage.removeItem('chatSession');
            currentSession = null;
            messages = [];
            isFirstInteraction = true; // Reset the flag
            document.getElementById('userInput').placeholder = 'Type your message...';

            renderChat();
            document.getElementById('newChatContainer').classList.remove('new-chat-visible');
        }

        //begin of renderChat function

        function renderChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            const newChatContainer = document.getElementById('newChatContainer');
            if (messages.length > 0) {
                newChatContainer.classList.add('new-chat-visible');
            } else {
                newChatContainer.classList.remove('new-chat-visible');
            }

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type}-message`;

                // For validation messages
                if (msg.validation) {
                    messageDiv.innerHTML = `
                        <div class="validation-text">
                            <strong>Let's dive deeper!</strong>
                            ${markdownToHTML(msg.content)}
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                    return;
                }

                // Main content container
                const contentWrapper = document.createElement('div');
                contentWrapper.style.display = 'flex';
                contentWrapper.style.flexDirection = 'column';
                contentWrapper.style.gap = '8px';

                // Text content
                const textElement = document.createElement('div');
                textElement.style.whiteSpace = 'pre-wrap';
                textElement.style.overflowWrap = 'break-word';
                textElement.style.flex = '1 1 auto';

                if (msg.type === 'bot') {
                    textElement.innerHTML = markdownToHTML(msg.content);
                } else {
                    textElement.textContent = msg.content;
                }

                contentWrapper.appendChild(textElement);

                // Bot-specific elements
                if (msg.type === 'bot') {
                    // Action buttons container
                    const actionContainer = document.createElement('div');
                    actionContainer.style.display = 'flex';
                    actionContainer.style.gap = '12px';
                    actionContainer.style.marginTop = '12px';
                    actionContainer.style.alignItems = 'center';

                    // Copy button
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button';
                    copyButton.title = 'Copy';
                    copyButton.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/>
                </svg>
                <span class="button-tooltip">Copy</span>
                
            `;

                    const copyFeedback = document.createElement('span');
                    copyFeedback.className = 'copy-success';
                    copyFeedback.textContent = 'Copied!';

                    copyButton.onclick = () => {
                        navigator.clipboard.writeText(msg.content).then(() => {
                            copyButton.parentElement.classList.add('show-copy-feedback');
                            setTimeout(() => {
                                copyButton.parentElement.classList.remove('show-copy-feedback');
                            }, 2000);
                        });
                    };

                    // Feedback buttons
                    const thumbsUpButton = document.createElement('button');
                    thumbsUpButton.className = 'feedback-button';
                    thumbsUpButton.title = 'Like this response';
                    thumbsUpButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md-heavy"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1318 2.50389C12.3321 2.15338 12.7235 1.95768 13.124 2.00775L13.5778 2.06447C16.0449 2.37286 17.636 4.83353 16.9048 7.20993L16.354 8.99999H17.0722C19.7097 8.99999 21.6253 11.5079 20.9313 14.0525L19.5677 19.0525C19.0931 20.7927 17.5124 22 15.7086 22H6C4.34315 22 3 20.6568 3 19V12C3 10.3431 4.34315 8.99999 6 8.99999H8C8.25952 8.99999 8.49914 8.86094 8.6279 8.63561L12.1318 2.50389ZM10 20H15.7086C16.6105 20 17.4008 19.3964 17.6381 18.5262L19.0018 13.5262C19.3488 12.2539 18.391 11 17.0722 11H15C14.6827 11 14.3841 10.8494 14.1956 10.5941C14.0071 10.3388 13.9509 10.0092 14.0442 9.70591L14.9932 6.62175C15.3384 5.49984 14.6484 4.34036 13.5319 4.08468L10.3644 9.62789C10.0522 10.1742 9.56691 10.5859 9 10.8098V19C9 19.5523 9.44772 20 10 20ZM7 11V19C7 19.3506 7.06015 19.6872 7.17071 20H6C5.44772 20 5 19.5523 5 19V12C5 11.4477 5.44772 11 6 11H7Z" fill="currentColor"></path></svg>
                <span class="button-tooltip">Like</span>
            `;

                    const thumbsDownButton = document.createElement('button');
                    thumbsDownButton.className = 'feedback-button';
                    thumbsDownButton.title = 'Dislike this response';
                    thumbsDownButton.innerHTML = `
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md-heavy"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.8727 21.4961C11.6725 21.8466 11.2811 22.0423 10.8805 21.9922L10.4267 21.9355C7.95958 21.6271 6.36855 19.1665 7.09975 16.7901L7.65054 15H6.93226C4.29476 15 2.37923 12.4921 3.0732 9.94753L4.43684 4.94753C4.91145 3.20728 6.49209 2 8.29589 2H18.0045C19.6614 2 21.0045 3.34315 21.0045 5V12C21.0045 13.6569 19.6614 15 18.0045 15H16.0045C15.745 15 15.5054 15.1391 15.3766 15.3644L11.8727 21.4961ZM14.0045 4H8.29589C7.39399 4 6.60367 4.60364 6.36637 5.47376L5.00273 10.4738C4.65574 11.746 5.61351 13 6.93226 13H9.00451C9.32185 13 9.62036 13.1506 9.8089 13.4059C9.99743 13.6612 10.0536 13.9908 9.96028 14.2941L9.01131 17.3782C8.6661 18.5002 9.35608 19.6596 10.4726 19.9153L13.6401 14.3721C13.9523 13.8258 14.4376 13.4141 15.0045 13.1902V5C15.0045 4.44772 14.5568 4 14.0045 4ZM17.0045 13V5C17.0045 4.64937 16.9444 4.31278 16.8338 4H18.0045C18.5568 4 19.0045 4.44772 19.0045 5V12C19.0045 12.5523 18.5568 13 18.0045 13H17.0045Z" fill="currentColor"></path></svg>
    <span class="button-tooltip">Dislike</span>
`;

                    // Event handlers
                    thumbsUpButton.addEventListener('click', () => handleFeedback(msg, 'positive'));
                    thumbsDownButton.addEventListener('click', () => handleFeedback(msg, 'negative'));

                    // Assemble buttons
                    const buttonGroup = document.createElement('div');
                    buttonGroup.style.display = 'flex';
                    buttonGroup.style.gap = '8px';
                    buttonGroup.style.alignItems = 'center';

                    buttonGroup.appendChild(copyButton);
                    buttonGroup.appendChild(thumbsUpButton);
                    buttonGroup.appendChild(thumbsDownButton);
                    buttonGroup.appendChild(copyFeedback);

                    actionContainer.appendChild(buttonGroup);
                    contentWrapper.appendChild(actionContainer);

                    // Related questions
                    if (msg.relatedQuestions?.length > 0) {
                        const relatedQuestionsDiv = document.createElement('div');
                        relatedQuestionsDiv.className = 'related-questions';

                        msg.relatedQuestions.forEach(question => {
                            const button = document.createElement('button');
                            button.className = 'related-question-btn';
                            button.textContent = question;
                            button.onclick = () => {
                                document.getElementById('userInput').value = question;
                                handleSendMessage();
                            };
                            relatedQuestionsDiv.appendChild(button);
                        });
                        contentWrapper.appendChild(relatedQuestionsDiv);
                    }

                    // References
                    if (msg.references?.length > 0) {
                        const referencesSection = document.createElement('div');
                        referencesSection.className = 'references-section';
                        msg.references.forEach(reference => {
                            if (reference.chunkInfo.relevanceScore >= 0.5) {
                                const referenceDiv = document.createElement('div');
                                const chunk = reference.chunkInfo;
                                const metadata = chunk.documentMetadata;
                                const title = metadata.title === 'untitled'
                                    ? metadata.uri.split('/').pop()
                                    : metadata.title;

                                const header = document.createElement('div');
                                header.className = 'reference-header';
                                header.innerHTML = `
                            <div>
                                <strong>${title}</strong><br>
                                <small>Relevance: ${Math.round(chunk.relevanceScore * 100)}%</small>
                            </div>
                            <svg class="chevron-icon" viewBox="0 0 24 24">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        `;

                                const content = document.createElement('div');
                                content.className = 'reference-content';
                                const truncatedContent = chunk.content.split(' ').slice(0, 40).join(' ') + '...';
                                content.innerHTML = `
                            <div class="chunk-info">
                                ${truncatedContent}
                            </div>
                            <a href="${metadata.uri}" class="doc-link" target="_blank">
                                View Source Document
                            </a>
                        `;

                                header.addEventListener('click', () => {
                                    content.classList.toggle('expanded');
                                    header.querySelector('.chevron-icon').classList.toggle('expanded');
                                });

                                referenceDiv.appendChild(header);
                                referenceDiv.appendChild(content);
                                referencesSection.appendChild(referenceDiv);
                            }
                        });
                        if (referencesSection.children.length > 0) {
                            contentWrapper.appendChild(referencesSection);
                        }
                    }
                }

                messageDiv.appendChild(contentWrapper);
                chatMessages.appendChild(messageDiv);
            });

            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });

            const inputContainer = document.querySelector('.input-container');
            if (messages.length === 0) {
                inputContainer.classList.add('initial');
            } else {
                inputContainer.classList.remove('initial');
            }
        }
        //end of renderChat() function

        // Add this feedback handler function
        function handleFeedback(message, feedbackType) {
            console.log('Feedback received:', feedbackType, 'for message:', {
                content: message.content.substring(0, 50) + '...',
                session: currentSession
            });
            console.log('Feedback received:', feedbackType);

            // Show thank you message
            const feedbackAlert = document.createElement('div');
            feedbackAlert.className = 'coming-soon-alert feedback-alert';
            feedbackAlert.textContent = 'Thank you for your feedback!';
            document.body.appendChild(feedbackAlert);

            // Show and animate
            setTimeout(() => {
                feedbackAlert.classList.add('show');

                // Remove after animation
                setTimeout(() => {
                    feedbackAlert.classList.remove('show');
                    setTimeout(() => {
                        feedbackAlert.remove();
                    }, 300);
                }, 2000);
            }, 10);
        }


        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Scroll event listener
        chatMessages.addEventListener('scroll', function () {
            const isAtBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 1;
            scrollToBottomBtn.classList.toggle('visible', !isAtBottom);
        });

        // Click handler for scroll button
        scrollToBottomBtn.addEventListener('click', () => {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        });

        // Add this at the bottom of your existing <script> section
        document.querySelector('.sign-in-btn').addEventListener('click', function (e) {
            e.preventDefault();

            if (sessionStorage.getItem('accessToken')) {
                // Already logged in
                return;
            }

            const state = generateRandomString(40);
            const codeVerifier = generateRandomString(128);

            sessionStorage.setItem('oidc_state', state);
            sessionStorage.setItem('code_verifier', codeVerifier);

            const authUrl = new URL(OIDC_CONFIG.authEndpoint);
            authUrl.searchParams.append('client_id', OIDC_CONFIG.clientId);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('scope', OIDC_CONFIG.scope);
            authUrl.searchParams.append('redirect_uri', OIDC_CONFIG.redirectUri);
            authUrl.searchParams.append('state', state);
            authUrl.searchParams.append('code_challenge', codeVerifier); // For production, use PKCE
            alert(authUrl.toString());
            window.location.href = authUrl.toString();

        });
        // Add this in your initialization code (e.g., at the end of the script)
        document.querySelector('.header-logo').src = `${getDomain()}/assets/engen-fullcolor-horizontal.png`;


        //the signin-block

        // Base64 encoded configuration

        const config = {
            clientId: 'YOUR_CLIENT_ID',
            redirectUri: "http://localhost:4200",
            authEndpoint: 'https://oauth.id.jumpcloud.com/oauth2/auth',
            tokenEndpoint: 'https://oauth.id.jumpcloud.com/oauth2/token',
            userInfoEndpoint: 'https://oauth.id.jumpcloud.com/userinfo',
            scope: 'openid email profile',
            clientSecret: 'YOUR_CLIENT_SECRET'
        };

        // Encode
        const encoded = btoa(JSON.stringify(config));
        console.log(encoded);
        //encode block ends


        const ENCODED_CONFIG = 'eyJjbGllbnRJZCI6IlhYWFhYWFhYLWFkMjctNGIyNS1hZDkxLWRjNGY4MjQ1Y2NmOSIsInJlZGlyZWN0VXJpIjoiaHR0cDovL2xvY2FsaG9zdDo0MjAwIiwiYXV0aEVuZHBvaW50IjoiaHR0cHM6Ly9vYXV0aC5pZC5qdW1wY2xvdWQuY29tL29hdXRoMi9hdXRoIiwidG9rZW5FbmRwb2ludCI6Imh0dHBzOi8vb2F1dGguaWQuanVtcGNsb3VkLmNvbS9vYXV0aDIvdG9rZW4iLCJ1c2VySW5mb0VuZHBvaW50IjoiaHR0cHM6Ly9vYXV0aC5pZC5qdW1wY2xvdWQuY29tL3VzZXJpbmZvIiwic2NvcGUiOiJvcGVuaWQgZW1haWwgcHJvZmlsZSIsImNsaWVudFNlY3JldCI6IlhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFgifQ==';

        const OIDC_CONFIG = JSON.parse(atob(ENCODED_CONFIG));

        function updateUIAfterLogin(userInfo) {
            const headerRight = document.querySelector('.header-right');
            headerRight.innerHTML = `
        <div style="display: flex; align-items: center; gap: 16px;">
            <span style="font-weight: 500;">${userInfo.name || userInfo.email}</span>
            <button class="sign-in-btn" onclick="handleSignOut()">Sign Out</button>
        </div>
    `;
        }

        function handleSignOut() {
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('oidc_state');
            sessionStorage.removeItem('code_verifier');
            window.location.reload();
        }
        // Add OIDC callback handler
        async function handleOidcCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                console.error('OIDC Error:', error, urlParams.get('error_description'));
                return;
            }

            if (code && state) {
                const savedState = sessionStorage.getItem('oidc_state');
                if (state !== savedState) {
                    console.error('Invalid state parameter');
                    return;
                }

                const tokenResponse = await exchangeCodeForToken(code);
                if (tokenResponse && tokenResponse.access_token) {
                    sessionStorage.setItem('accessToken', tokenResponse.access_token);

                    const userInfo = await getUserInfo(tokenResponse.access_token);
                    if (userInfo) {
                        sessionStorage.setItem('userInfo', JSON.stringify(userInfo));
                        updateUIAfterLogin(userInfo);
                    }
                }

                // Cleanup URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Add these utility functions
        function generateRandomString(length) {
            const array = new Uint32Array(length);
            window.crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).slice(-2)).join('').substring(0, length);
        }

        async function exchangeCodeForToken(code) {
            const codeVerifier = sessionStorage.getItem('code_verifier');

            const params = new URLSearchParams();
            params.append('client_id', OIDC_CONFIG.clientId);
            params.append('client_secret', OIDC_CONFIG.clientSecret);
            params.append('code', code);
            params.append('grant_type', 'authorization_code');
            params.append('redirect_uri', OIDC_CONFIG.redirectUri);
            params.append('code_verifier', codeVerifier);

            try {
                const response = await fetch(OIDC_CONFIG.tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                });

                if (!response.ok) throw new Error('Token exchange failed');
                return await response.json();
            } catch (error) {
                console.error('Token exchange error:', error);
                return null;
            }
        }

        async function getUserInfo(accessToken) {
            try {
                const response = await fetch(OIDC_CONFIG.userInfoEndpoint, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('User info error:', error);
                return null;
            }
        }

        // Add this to DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function () {
            const userInfo = sessionStorage.getItem('userInfo');
            if (userInfo) {
                updateUIAfterLogin(JSON.parse(userInfo));
            }

            handleOidcCallback(); // Check for OIDC callback
        });
        //sign-in block ends

        renderChat();




    </script>

</body>

</html>